<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Argyle Graph App</title>

    <!-- Load JQuery -->
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>
    
    <!-- Load MS Graph SDK-->
    <script type="text/javascript" src="https://unpkg.com/@microsoft/microsoft-graph-client@1.0.0/lib/graph-js-sdk-web.js"></script>

    <!-- Load MS MDAL Library-->
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.min.js"></script>
    <script>
        
    </script>
</head>
<body>
    <form id="form1">
        <input type="text" id="txtClientID" />
        <input type="button" id="btnSearch" onclick="javascript:LoadGraph()" />

        <script type="text/javascript">
            async function LoadGraph() {
                var myClientID = $('#txtClientID').val();

                ///////#1
                var msalConfig = {
                    auth: {
                        clientId: myClientID,
                        authority: "https://login.microsoftonline.com/"
                    }
                    ,
                    cache: {
                        cacheLocation: "localStorage",
                        storeAuthStateInCookie: true
                    }
                };

                var msalInstance = new Msal.UserAgentApplication(msalConfig);

                msalInstance.handleRedirectCallback((error, response) => {
                    // handle redirect response or error
                });

///////#2
                var loginRequest = {
                    scopes: ["user.read", "mail.send"] // optional Array<string>
                };

                msalInstance.loginPopup(loginRequest)
                    .then(response => {
                        // handle response
                    })
                    .catch(err => {
                        // handle error
                    });


                /// #3
                // if the user is already logged in you can acquire a token
    if (msalInstance.getAccount()) {
        var tokenRequest = {
            scopes: ["user.read", "mail.send"]
        };
        msalInstance.acquireTokenSilent(tokenRequest)
            .then(response => {
                // get access token from response
                // response.accessToken
            })
            .catch(err => {
                // could also check if err instance of InteractionRequiredAuthError if you can import the class.
                if (err.name === "InteractionRequiredAuthError") {
                    return msalnstance.acquireTokenPopup(tokenRequest)
                        .then(response => {
                            // get access token from response
                            // response.accessToken
                        })
                        .catch(err => {
                            // handle error
                        });
                }
            });
    } else {
        // user is not logged in, you will need to log them in to acquire a token
    }

                ////#4
                var headers = new Headers();
    var bearer = "Bearer " + token;
    headers.append("Authorization", bearer);
    var options = {
         method: "GET",
         headers: headers
    };
    var graphEndpoint = "https://graph.microsoft.com/v1.0/me";

    fetch(graphEndpoint, options)
        .then(resp => {
             //do something with response
             console.log(resp.status);
        });

            }
        </script>
    </form>
</body>
</html>
