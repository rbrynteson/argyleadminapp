<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <title>Argyle Graph App</title>

    <!-- Load JQuery -->
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>

    <!-- Load MS Msal Info -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.0/js/msal.js"></script>

    <!-- Load MS Graph SDK-->
    <script type="text/javascript" src="https://unpkg.com/@microsoft/microsoft-graph-client@1.0.0/lib/graph-js-sdk-web.js"></script>

    <!-- Bootstrap (https://getbootstrap.com/) 
    <link rel="stylesheet" href="/styles/bootstrap/bootstrap.min.css" crossorigin="anonymous" />
    <script src="/javascript/bootstrap/bootstrap.min.js" crossorigin="anonymous"></script>
    -->

    <!-- Cookie -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="leftContainer">
            <p id="WelcomeMessage">Welcome to the Microsoft Authentication Library For Javascript Quickstart</p>
            <button id="SignIn" onclick="signIn()">Sign In</button>
            <button id="Teams" onclick="TeamList()">Get Team List</button>
        </div>
        <div class="rightContainer">
            <pre id="teamList"></pre>
            <pre id="json"></pre>
        </div>
    </div>
    <script>
        // Get Values of Client and Tenant ID.  If null, 
        var ClientID = Cookies.get("ClientID");
        var TenantID = Cookies.get("TenantID");
        if (typeof(ClientID)  === "undefined" || typeof(TenantID)  === "undefined") { $(location).attr("href", "settings.html"); } 

        // Object to Store Channel Results
        function ChannelList(teamID, teamName, channelID, channelName, lastPostedMessage, lastPostedFile) {
            this.teamID = teamID;
            this.teamName = teamName;
            this.channelID = channelID;
            this.channelName = channelName;
            this.lastPostedMessage = lastPostedMessage;
            this.lastPostedFile = lastPostedFile;
        }

        // Web Call
        function WebOpen(XmlHttp, URL, AccessToken) {
            XmlHttp.open("GET", URL, true); // true for asynchronous
            XmlHttp.setRequestHeader('Authorization', 'Bearer ' + AccessToken);
            XmlHttp.send();
        }

        ////// TEAMS
        // Get List of Teams
        function TeamList() {
            myMSALObj.acquireTokenSilent(requestObj).then(function (tokenResponse) {
                callTeamList(graphConfig.graphTeamEndpoint, tokenResponse.accessToken, callbackTeamList);
            }).catch(function (error) {
                console.log(error);
                if (requiresInteraction(error.errorCode)) {
                    myMSALObj.acquireTokenPopup(requestObj).then(function (tokenResponse) {
                        callTeamList(graphConfig.graphTeamEndpoint, tokenResponse.accessToken, callbackTeamList);
                    }).catch(function (error) {
                        console.log(error);
                    });
                }
            });
        }

        // Get List of Teams - Web Call
        function callTeamList(theUrl, accessToken, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200)
                    callback(JSON.parse(this.responseText));
            }

            WebOpen(xmlHttp, theUrl, accessToken);
        }

        // Loop Teams Results.  Get Channels
        function callbackTeamList(TeamListArray) {
            var x = TeamListArray.value.length;
            for (i = 0; i < x; i++) {
                var id = TeamListArray.value[i].id;
                var name = TeamListArray.value[i].displayName;
                getTeamChannels(id, name);
            }
        }

        //////CHANNELS
        // Get List of Channels
        function getTeamChannels(teamID, teamName) {
            var url = "https://graph.microsoft.com/beta/teams/" + teamID + "/channels";
            myMSALObj.acquireTokenSilent(requestObj).then(function (tokenResponse) {
                callChannelList(url, tokenResponse.accessToken, teamID, teamName, callbackChannelList);
            }).catch(function (error) {
                console.log(error);
                if (requiresInteraction(error.errorCode)) {
                    myMSALObj.acquireTokenPopup(requestObj).then(function (tokenResponse) {
                        callChannelList(graphConfig.graphTeamEndpoint, tokenResponse.accessToken, ID, callbackChannelList);
                    }).catch(function (error) {
                        console.log(error);
                    });
                }
            });
        }

        // Get List of Channels - Web Call
        function callChannelList(theUrl, accessToken, teamID, teamName, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200)
                    callback(teamID, teamName, JSON.parse(this.responseText));
            }
            WebOpen(xmlHttp, theUrl, accessToken);
        }

        // Loop Channels Results.  
        function callbackChannelList(teamID, teamName, data) {
            var x = data.value.length;
            for (i = 0; i < x; i++) {
                var cid = data.value[i].id;
                var cname = data.value[i].displayName;
                var result = new ChannelList(teamID, teamName, cid, cname, "", "");
                getTeamChannelLastPost(result);
            }
        }

        //////GET LAST POST
        // Get Last Message in Channel
        function getTeamChannelLastPost(result) {
            var url = "https://graph.microsoft.com/beta/teams/" + result.teamID + "/channels/" + result.channelID + "/messages?$top=1";
            myMSALObj.acquireTokenSilent(requestObj).then(function (tokenResponse) {
                callMessagePost(url, tokenResponse.accessToken, result, callbackLastMessagePosted);
            }).catch(function (error) {
                console.log(error);
                if (requiresInteraction(error.errorCode)) {
                    myMSALObj.acquireTokenPopup(requestObj).then(function (tokenResponse) {
                        callMessagePost(graphConfig.graphTeamEndpoint, tokenResponse.accessToken, callbackLastMessagePosted);
                    }).catch(function (error) {
                        console.log(error);
                    });
                }
            });
        }

        // Get Last Message - Web Call
        function callMessagePost(theUrl, accessToken, result, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200)
                    callback(result, JSON.parse(this.responseText));
            }
            WebOpen(xmlHttp, theUrl, accessToken);
        }

        // Loop Through Last Post Results
        function callbackLastMessagePosted(result, data) {
            var x = data.value.length;
            for (i = 0; i < x; i++) {
                result.lastPostedMessage = data.value[i].createdDateTime;
                //console.log(result);
                $("#teamList").append(JSON.stringify(result, null, 2));
            }
        }



        




        // Set Keys
        var msalConfig = {
            auth: {
                clientId: ClientID, 
                authority: "https://login.microsoftonline.com/" + TenantID
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: true
            }
        };

        var graphConfig = {
            graphMeEndpoint: "https://graph.microsoft.com/beta/me",
            graphTeamEndpoint: "https://graph.microsoft.com/beta/groups?$filter=resourceProvisioningOptions/Any(x:x eq 'Team')"
        };

        // Initial Request For Scope
        var requestObj = {
            scopes: ["user.read"]
        };

        //Create User Agent Application
        var myMSALObj = new Msal.UserAgentApplication(msalConfig);

        // Register Callbacks for redirect flow
        myMSALObj.handleRedirectCallback(authRedirectCallBack);

        // Sign In-Function
        function signIn() {
            myMSALObj.loginPopup(requestObj).then(function (loginResponse) {
                //Successful login
                showWelcomeMessage();
            }).catch(function (error) {
                //Please check the console for errors
                console.log(error);
            });
        }

        function signOut() {
            myMSALObj.logout();
        }

        function callMSGraph(theUrl, accessToken, callback) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200)
                    callback(JSON.parse(this.responseText));
            }
            WebOpen(xmlHttp, theUrl, accessToken);
        }

        function graphAPICallback(data) {
            document.getElementById("json").innerHTML = JSON.stringify(data, null, 2);
        }

        function showWelcomeMessage() {
            var divWelcome = document.getElementById('WelcomeMessage');
            divWelcome.innerHTML = "Welcome " + myMSALObj.getAccount().userName + " to Microsoft Graph API";
            var loginbutton = document.getElementById('SignIn');
            loginbutton.innerHTML = 'Sign Out';
            loginbutton.setAttribute('onclick', 'signOut();');
        }

        function authRedirectCallBack(error, response) {
            if (error) {
                console.log(error);
            } else {
                if (response.tokenType === "access_token") {
                    callMSGraph(graphConfig.graphMeEndpoint, response.accessToken, graphAPICallback);
                } else {
                    console.log("token type is:" + response.tokenType);
                }
            }
        }

        function requiresInteraction(errorCode) {
            if (!errorCode || !errorCode.length) {
                return false;
            }
            return errorCode === "consent_required" ||
                errorCode === "interaction_required" ||
                errorCode === "login_required";
        }

        // runs on page load, change config to try different login types to see what is best for your application
        if (myMSALObj.getAccount()) {
            showWelcomeMessage();
        }
    </script>
</body>
</html>
